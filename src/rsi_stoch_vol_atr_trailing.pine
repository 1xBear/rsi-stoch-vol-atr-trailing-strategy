//@version=6
strategy('RSI Stoch + Vol + ATR Trailing', overlay=true, initial_capital=10000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0.1, process_orders_on_close=true)


// RSI Stoch + Volume + ATR Trailing
// Author: Gabriel Padilla
// Version: 1.0.0

// Description:
//     Long-only TradingView strategy that combines:
//     - 200 EMA trend filter
//     - Volume above average confirmation
//     - RSI + Stochastic oscillator entry logic
//     - ATR-based trailing stop for volatility-adjusted exits


// --- Inputs ---
// Trend Filter
useTrendFilter = input.bool(true, title="Use 200 EMA Trend Filter?")
emaLen = input.int(200, title="Trend Filter Length")

// Volume Filter
useVolFilter = input.bool(true, title="Require Volume > Avg?")
volLen = input.int(20, title="Volume Avg Length")

// Oscillator Settings
rsiLen = input.int(14, minval=1, title='RSI Length')
stochLen = input.int(14, minval=1, title='Stoch Length')
smoothK = input.int(3, minval=1, title='Stoch K Smoothing')
rsiBuyLevel = input.float(55.0, title='RSI Buy Below (Relaxed)') // Raised slightly to catch more valid moves
stochBuyLevel = input.float(60.0, title='Stoch Buy Below')       // Raised to allow momentum entries

// ATR Trailing Stop Settings
atrLen = input.int(14, title="ATR Length")
atrMultiplier = input.float(3.0, title="ATR Trailing Multiplier") // 3x ATR is standard for Crypto Daily

// Date Filter
startYear = input.int(2011, title="Start Year")
endYear = input.int(2069, title="End Year")
inDateRange = time >= timestamp(startYear, 1, 1, 0, 0) and time < timestamp(endYear, 12, 31, 23, 59)

// --- Indicators ---
rsi = ta.rsi(close, rsiLen)
k = ta.sma(ta.stoch(high, low, close, stochLen), smoothK)
emaTrend = ta.ema(close, emaLen)
volAvg = ta.sma(volume, volLen)
atr = ta.atr(atrLen)

// --- Logic ---
// 1. Trend Filter: Price above 200 EMA
isBullish = not useTrendFilter or (close > emaTrend)

// 2. Volume Filter
volConfirm = not useVolFilter or (volume > volAvg)

// 3. Trigger: Stoch Cross + RSI check
rsiAllowed = rsi < rsiBuyLevel
stochCross = ta.crossover(k, stochBuyLevel)

// Final Buy Signal
buySignal = isBullish and volConfirm and rsiAllowed and stochCross

// --- Trailing Stop Logic ---
// We calculate the stop price based on ATR
var float trailStop = na
float longStopPrice = na

if strategy.position_size > 0
    // If we are in a trade, calculate where the stop should be (High - 3xATR)
    float potentialStop = close - (atr * atrMultiplier)
    
    // Ratchet Mechanism
    if (na(trailStop))
        trailStop := potentialStop
    else
        trailStop := math.max(trailStop, potentialStop)
else
    // Reset when not in a trade
    trailStop := na

// --- Execution ---
canEnter = strategy.position_size == 0

if inDateRange and canEnter and buySignal
    strategy.entry('Long', strategy.long)

// Exit only via Trailing Stop (or if price drops below it)
if strategy.position_size > 0
    strategy.exit("Trailing Stop", from_entry="Long", stop=trailStop)

// --- Visualization ---
// Plot 200 EMA
plot(useTrendFilter ? emaTrend : na, color=color.gray, title="200 EMA")

// Plot Trailing Stop (Only when in a trade)
plot(strategy.position_size > 0 ? trailStop : na, color=color.red, style=plot.style_linebr, linewidth=2, title="ATR Trailing Stop")

// Signals
plotshape(buySignal and canEnter, title='Buy', style=shape.triangleup, location=location.belowbar, color=color.lime, size=size.small)

bgcolor(strategy.position_size > 0 ? color.new(color.lime, 90) : na)